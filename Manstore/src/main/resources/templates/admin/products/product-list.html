<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" data-layout="vertical" data-topbar="light" data-sidebar="light"
      data-sidebar-size="lg" data-sidebar-image="none" data-preloader="disable" data-body-image="none">
<head th:replace="admin/fragments/head::head">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.1.0/remixicon.css"
        integrity="sha512-dUOcWaHA4sUKJgO7lxAQ0ugZiWjiDraYNeNJeRKGOIpEq4vroj1DpKcS3jP0K4Js4v6bXk31AAxAxaYt3Oi9xw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.min.css">
</head>
<body>
<!-- Begin page -->
<div id="layout-wrapper">
  <div th:replace="admin/fragments/header::header"></div>
  <!-- ========== App Menu ========== -->
  <div th:replace="admin/fragments/sidebar::sidebar"></div>
  <!-- Left Sidebar End -->
  <!-- ============================================================== -->
  <!-- Start right Content here -->
  <!-- ============================================================== -->
  <div class="main-content">
    <div class="page-content">
      <div class="container-fluid">
        <!-- start page title -->
        <div class="row" style="padding: 10px 10px">
          <div class="col-12">
            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
              <h4 class="mb-sm-0">Danh Sách Sản Phẩm</h4>
              <div class="page-title-right">
                <ol class="breadcrumb m-0">
                  <li class="breadcrumb-item"><a href="javascript: void(0);">Sản Phẩm</a></li>
                  <li class="breadcrumb-item active">Danh Sách Sản Phẩm</li>
                </ol>
              </div>

            </div>
          </div>
        </div>
        <!-- end page title -->

        <div class="row" style="padding: 10px 10px">
          <div class="col-lg-12">
            <div class="card">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-8 d-flex justify-content-center align-items-center ">
                    <div class="row w-100" style="padding-bottom: 10px">
                      <div class="col-md-3">
                        <label class="form-label">Sắp Xếp</label>
                        <select class="form-control mb-3"
                                aria-label=".form-select-lg example"
                                id="sort"
                                onchange="sorted(0)">
                          <option value="ngayTao,desc" selected>Mới nhất</option>
                          <option value="ngayTao,asc">Cũ nhất</option>
                          <option value="gia,desc">Giá giảm dần</option>
                          <option value="gia,asc">Giá tăng dần</option>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <label class="form-label">Trạng Thái</label>
                        <select class="form-control mb-3"
                                aria-label=".form-select-lg example"
                                id="filter-status"
                                onchange="statusCheck()">
                          <option value="-1" selected>Tất Cả</option>
                          <option value="1">Đang mở bán</option>
                          <option value="0">Chưa mở bán</option>
                        </select>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Danh Mục</label>
                        <select class="form-control mb-3" aria-label=".form-select-lg example" id="filter-category" onchange="categoryCheck()">
                          <option value="-1" selected>Tất Cả</option>
                        </select>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Thương Hiệu</label>
                        <select class="form-control mb-3" aria-label=".form-select-lg example" id="filter-trademark" onchange="trademarkCheck()">
                          <option value="-1" selected>Tất Cả</option>
                        </select>
                      </div>

                    </div>

                  </div>

                  <div class="col-md-4 d-flex justify-content-center align-items-center p-0">
                    <div class="col-md-6">
                      <div class="search-box ms-2">
                        <input type="text" class="form-control" autocomplete="off"
                               id="search-product-input" placeholder="Tìm Kiếm"
                               onkeyup="searchProductByNameOrCode()"/>
                        <i class="ri-search-line search-icon"></i>
                      </div>
                    </div>

                    <div class="col-md-2 d-flex justify-content-center align-items-cente">
                      <button class="btn btn-primary" onclick="resetFilter()"><i
                              class="bi bi-arrow-clockwise"></i>
                      </button>
                    </div>
                    <div class="col-md-6">
                      <a th:href="@{/admin/product/add}" class="btn btn-success"
                         id="addproduct-btn"><i class="ri-add-line align-bottom me-1"></i> Thêm Sản Phẩm</a>
                    </div>
                  </div>

                </div>
              </div>
            </div>

            <div class="card p-2">
              <div id="product-list" class="gridjs-border-none mb-4">
                <table class="table table-striped">
                  <thead class="table-light">
                  <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Mã</th>
                    <th scope="col">Tên</th>
                    <th scope="col">Ảnh</th>
                    <th scope="col">Số Lượng</th>
                    <th scope="col">Ngày tạo</th>
                    <th scope="col">Đơn Giá</th>
                    <th scope="col">Danh Mục</th>
                    <th scope="col">Thương Hiệu</th>
                    <th scope="col">Trạng Thái</th>
                    <th scope="col">Hàng Động</th>
                  </tr>
                  </thead>
                  <tbody style="font-weight: normal" id="list_Product">
                  </tbody>
                </table>
                <div class="row">
                  <div class="col-lg-3"></div>
                  <div class="col-lg-1"></div>
                  <div class="col-lg-4">
                    <nav aria-label="Page navigation example">
                      <ul class="pagination justify-content-center" id="pagination">
                      </ul>
                    </nav>
                  </div>
                  <div class="col-lg-3"></div>
                  <div class="col-lg-1"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- end card -->
      </div>
      <div class="modal" id="myModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">Chi Tiết Sản Phẩm</h4>
              <button type="button" class="btn-close" data-bs-dismiss="modal"
                      aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <form id="update-form" action="" class="my-form" method="post">
                <div class="card">
                  <div class="card-body">
                    <div class="row">
                      <div class="col-lg-6">
                        <div class="mb-3">
                          <label class="form-label" for="product-name-update-input">Tên Sản Phẩm</label>
                          <input type="text" class="form-control" id="product-name-update-input"
                                 placeholder="Nhập tên" onkeyup="validName()">
                        </div>
                        <span id="error-name-update" class="text-danger fw-bold"></span>
                      </div>
                      <div class="col-lg-6 col-sm-6">
                        <div class="mb-3">
                          <label class="form-label" for="product-price-update-input">Giá</label>
                          <div class="input-group has-validation mb-3">
                            <span class="input-group-text" id="product-price-addon">VND</span>
                            <input type="number" class="form-control" id="product-price-update-input"
                                   placeholder="Nhập giá" aria-label="Price" aria-describedby="product-price-addon"
                                   required onkeyup="validPrice()">
                          </div>
                        </div>
                        <span id="error-price-update" class="text-danger fw-bold"></span>
                      </div>
<!--                      <div class="col-lg-4 col-sm-6">-->
<!--                        <div class="mb-3">-->
<!--                          <label class="form-label" for="product-priceSale-update-input">Giá Sale</label>-->
<!--                          <div class="input-group has-validation mb-3">-->
<!--                            <span class="input-group-text" id="product-priceSale-addon">VND</span>-->
<!--                            <input type="number" class="form-control" id="product-priceSale-update-input"-->
<!--                                   placeholder="Nhập giá sale" aria-label="Price"-->
<!--                                   aria-describedby="product-priceSale-addon"-->
<!--                                   required onkeyup="validPriceSale()">-->
<!--                          </div>-->
<!--                        </div>-->
<!--                        <span id="error-priceSale-update" class="text-danger fw-bold"></span>-->
<!--                      </div>-->
                      <!--                      <div class="col-lg-4 col-sm-6">-->
                      <!--                        <div class="mb-3">-->
                      <!--                          <label class="form-label" for="product-quantity-update-input">Số lượng</label>-->
                      <!--                          <input type="number" class="form-control" id="product-quantity-update-input"-->
                      <!--                                 placeholder="Nhập số lượng" onkeyup="validQuantity()">-->
                      <!--                        </div>-->
                      <!--                        <span id="error-quantity-update" class="text-danger fw-bold"></span>-->
                      <!--                      </div>-->
                      <div class="col-lg-4">
                        <div class="mb-3">
                          <label class="form-label">Loại Cổ Áo</label>
                          <select class="form-select mb-3" aria-label=".form-select-lg example"
                                  id="product-collar-update-input" onchange="validCollar()">
                          </select>
                          <span id="error-collar-update" class="text-danger fw-bold"></span>
                        </div>
                      </div>
                      <div class="col-lg-4">
                        <div class="mb-3">
                          <label class="form-label">Loại Đuôi Áo</label>
                          <select class="form-select mb-3" aria-label=".form-select-lg example"
                                  id="product-shirtTail-update-input" onchange="">
                          </select>
                          <span id="error-shirTail-update" class="text-danger fw-bold"></span>
                        </div>
                      </div>
                      <div class="col-lg-4">
                        <div class="mb-3">
                          <label class="form-label">Kiểu Dáng</label>
                          <select class="form-select mb-3" aria-label=".form-select-lg example"
                                  id="product-designs-update-input" onchange="">
                          </select>
                          <span id="error-desgins-update" class="text-danger fw-bold"></span>
                        </div>
                      </div>
                      <div class="col-lg-4">
                        <div class="mb-3">
                          <label class="form-label">Chất Liệu</label>
                          <select class="form-select mb-3" aria-label=".form-select-lg example"
                                  id="product-material-update-input" onchange="">
                          </select>
                          <span id="error-material-update" class="text-danger fw-bold"></span>
                        </div>
                      </div>
                      <div class="col-lg-4">
                        <div class="mb-3">
                          <label class="form-label">Danh Mục</label>
                          <select class="form-select mb-3" aria-label=".form-select-lg example"
                                  id="product-category-update-input" onchange="validCollections()">
                            <!--                            <option selected value="-1">Open this select menu</option>-->
                          </select>
                          <span id="error-category-update" class="text-danger fw-bold"></span>
                        </div>
                      </div>
                      <div class="col-lg-4">
                        <div class="md-3">
                          <label class="form-label">Thương Hiệu</label>
                          <select class="form-select mb-3" aria-label=".form-select-lg example"
                                  id="product-brand-update-input" onchange="validBrand()">
                          </select>
                          <span id="error-brand-update" class="text-danger fw-bold"></span>
                        </div>
                      </div>
                    </div>
                    <!-- end row -->

                    <div class="row">
                      <div class="col-lg-4">
                        <div class="mb-3">
                          <label class="form-label" for="product-description-update-input">Mô Tả</label>
                          <textarea type="number" class="form-control" id="product-description-update-input"
                                    placeholder="Nhập mô tả" onkeyup=""></textarea>
                        </div>
                        <span id="error-description-update" class="text-danger fw-bold"></span>
                      </div>
                      <div class="col-lg-8">
                        <div class="mb-3">
                          <label class="form-label" for="product-imageEdit">Hình Ảnh <span class="text-danger"
                                                                                           id="required-product-img"
                                                                                           style="display:none;">*</span></label>
                          <input type="file" class="form-control" id="product-imageEdit" accept="image/*" multiple
                                 value="" onchange="previewImgProductEdit(event)">
                          <div id="image-preview-productImgEdit" class="d-flex g-2 mt-2"></div>
                          <span id="errorImg" class="text-danger fw-bold"></span>
                        </div>
                      </div>
                      <input type="hidden" id="image-path-productEdit" name="duongDan">
                    </div>
                    <!--end row-->

                    <div class="row">
                      <div class="col-lg-4">
                        <div class="mb-3">
                          <label class="form-label">Trạng Thái</label>
                          <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" id="radioStatus1" value="1"
                                   name="status-update">
                            <label class="form-check-label" for="radioStatus1">Đang mở bán</label>
                            <br>
                            <input class="form-check-input" type="radio" id="radioStatus2" value="0"
                                   name="status-update">
                            <label class="form-check-label" for="radioStatus2">Chưa mở bán</label>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- end col -->
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="showConfirmPopup()">Lưu</button>
                  </div>
                  <!-- end row -->
                </div>
              </form>
            </div>

            <!-- end col -->
          </div>
          <!-- end row -->
        </div>
      </div>
      <!--end modal-->
      <div class="modal" id="myModalTable" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">Danh Sách Chi Tiết Sản Phẩm</h4>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="card p-2" style="height: 115px;">
                <div class="row">
                  <div class="col-md-4 d-flex justify-content-center align-items-center justify-content-sm-start">
                    <button class="btn btn-success" id="add-product-detail-btn" onclick="showModalAddProductDetail()">
                      <i class="ri-add-line align-bottom me-1"></i> Thêm Sản Phẩm Chi Tiết
                    </button>
                  </div>
                  <div class="col-md-3 d-flex justify-content-center align-items-center justify-content-sm-between">
                    <div class="row" style="padding-bottom: 25px">
                      <label class="form-label">Tên Sản Phẩm</label>
                      <input type="text" class="form-control" id="productDetail-name" readonly>
                    </div>
                  </div>
                  <div class="col-md-4 d-flex justify-content-center align-items-center justify-content-sm-between">
                    <div class="row" style="padding-bottom: 10px">
                      <div class="col-md-6">
                        <label class="form-label">Màu Sắc</label>
                        <select class="form-select mb-3" aria-label=".form-select-lg example" id="filter-color"
                                onchange="viewProductDetail(idProduct,undefined)">
                          <option value="0" selected>Tất Cả</option>
                          <option value="1">Đen</option>
                          <option value="2">Trắng</option>
                          <option value="3">Đỏ</option>
                          <option value="4">Xám</option>
                          <option value="5">Xanh Lục</option>
                          <option value="6">Tím Xanh</option>
                          <option value="7">Xanh Da Trời</option>
                          <option value="8">Vàng</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Size</label>
                        <select class="form-select mb-3" aria-label=".form-select-lg example" id="filter-size"
                                onchange="viewProductDetail(idProduct,undefined)">
                          <option value="0" selected>Tất Cả</option>
                          <option value="1">S</option>
                          <option value="2">M</option>
                          <option value="3">L</option>
                          <option value="4">XL</option>
                          <option value="5">XXL</option>
                          <option value="6">2XL</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card p-2">
                <div id="product-detail-list" class="gridjs-border-none mb-4">
                  <table class="table table-striped">
                    <thead class="table-light">
                    <tr>
                      <th scope="col">ID</th>
                      <th scope="col">Ảnh</th>
                      <th scope="col">Số Lượng</th>
                      <th scope="col">Màu Sắc</th>
                      <th scope="col">Size</th>
                      <th scope="col">Hành Động</th>
                    </tr>
                    </thead>
                    <tbody style="font-weight: normal" id="list_Product_Detail">
                    </tbody>
                  </table>
                  <div class="row">
                    <div class="col-lg-3"></div>
                    <div class="col-lg-1"></div>
                    <div class="col-lg-4">
                      <nav aria-label="Page navigation example">
                        <ul class="pagination justify-content-center" id="pagination2">
                        </ul>
                      </nav>
                    </div>
                    <div class="col-lg-3"></div>
                    <div class="col-lg-1"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
          </div>
          <!-- end col -->
        </div>
        <!-- end row -->
      </div>
    </div>
  </div>
</div>

<!-- form add chi tiet san pham-->
<div class="modal" id="myModalView" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Thêm Sản Phẩm Chi Tiết</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="margin-bottom: 20px;">
        <form id="save_product_detail" action="" class="my-form" method="post">
          <div class="card p-2">
            <div class="row">
              <div class="col-lg-6">
                <div class="mb-3">
                  <label class="form-label">Tên Sản Phẩm</label>
                  <input type="text" class="form-control" id="product-detail-name-input"
                         placeholder="Enter product name" disabled>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="mb-3">
                  <label class="form-label">Màu Sắc</label>
                  <select class="form-select mb-3" id="product-color-detail-input">
                  </select>
                  <span id="errorColor" class="text-danger fw-bold"></span>
                </div>
              </div>
            </div>
            <!-- end row -->

            <div class="row">
              <div class="col-lg-6">
                <div class="mb-3">
                  <label class="form-label">Số Lượng</label>
                  <input type="text" class="form-control" id="product-detail-count-input"
                         placeholder="Enter count" aria-label="Count"
                         aria-describedby="product-count-addon" required>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="mb-3">
                  <label class="form-label">Size</label>
                  <select class="form-select mb-3" id="product-size-detail-input">
                  </select>
                  <span id="errorSize" class="text-danger fw-bold"></span>
                </div>
              </div>
            </div>
            <!-- end row -->

            <div class="row" style="display: none">
              <div class="col-lg-12">
                <div class="mb-3">
                  <label class="form-label">Trạng Thái </label>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" id="add-detail-radioStatus1" value="1"
                           name="trangThai" checked>
                    <label class="form-check-label" for="add-detail-radioStatus1">
                      Còn Hàng
                    </label>
                    <br>
                    <input class="form-check-input" type="radio" id="add-detail-radioStatus2" value="0"
                           name="trangThai">
                    <label class="form-check-label" for="add-detail-radioStatus2">
                      Hết Hàng
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-lg-6">
                <div class="mb-3">
                  <label class="form-label" for="product-image-input">Hình Ảnh <span class="text-danger"
                                                                                     id="required-image"
                                                                                     style="display:none;">*</span></label>
                  <input type="file" class="form-control" id="product-image-input" accept="image/*" multiple
                         value="" onchange="previewImageProductDetail(event)">
                  <div id="image-preview-container-productDetail" class="d-flex g-2 mt-2"></div>
                  <span id="errorImage" class="text-danger fw-bold"></span>
                </div>
              </div>
            </div>
            <!-- end row -->
            <input type="hidden" id="image-path-input" name="duongDan">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Đóng
        </button>
        <button type="button" class="btn btn-primary" onclick="showConfirmPopupSave()"
                id="btnSaveProductDetail">
          Lưu
        </button>
      </div>
    </div>
  </div>
</div>


<!-- form edit chi tiet san pham-->
<!-- HTML part for update modal -->
<div class="modal" id="myModalEdit" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Cập Nhật Sản Phẩm Chi Tiết</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="margin-bottom: 20px;">
        <form id="edit_product_detail" action="" class="my-form" method="post">
          <div class="card p-2">
            <div class="card-body">
              <div class="row">
                <div class="col-lg-6">
                  <div class="mb-3">
                    <label class="form-label">Tên Sản Phẩm</label>
                    <input type="text" class="form-control" id="product-name-input-edit"
                           placeholder="Enter product name" disabled>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="mb-3">
                    <label class="form-label">Màu Sắc</label>
                    <select class="form-select" id="color-select-edit"></select>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-6">
                  <div class="mb-3">
                    <label class="form-label">Số Lượng</label>
                    <input type="text" class="form-control" id="productdetail-count-input-edit"
                           placeholder="Nhập số lượng" aria-label="Count"
                           aria-describedby="product-count-addon" required>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="mb-3">
                    <label class="form-label">Size</label>
                    <select class="form-select" id="size-select-edit"></select>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-6">
                  <div class="mb-3">
                    <label class="form-label" for="product-image-input-edit">Hình Ảnh <span class="text-danger"
                                                                                            id="required-image-edit"
                                                                                            style="display:none;">*</span></label>
                    <input type="file" class="form-control" id="product-image-input-edit"
                           value="" onchange="previewImageProductDetailEdit(event)">
                    <div id="image-preview-container-productDetail-edit" class="d-flex g-2 mt-2"></div>
                    <span id="errorImageEdit" class="text-danger fw-bold"></span>
                  </div>
                </div>
              </div>
              <div class="row" style="display: none">
                <div class="col-lg-12">
                  <div class="mb-3">
                    <label class="form-label">Trạng Thái </label>
                    <div class="form-check mb-3">
                      <input class="form-check-input" type="radio" id="update-RadioStatus1" value="1" name="trangThai">
                      <label class="form-check-label" for="update-RadioStatus1">Còn Hàng</label>
                      <br>
                      <input class="form-check-input" type="radio" id="update-RadioStatus2" value="0" name="trangThai">
                      <label class="form-check-label" for="update-RadioStatus2">Hết Hàng</label>
                    </div>
                  </div>
                </div>
              </div>
              <input type="hidden" id="image-path-input-edit" name="duongDan">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button type="button" class="btn btn-primary" onclick="showConfirmPopupUpdate()">Lưu</button>
      </div>
    </div>
  </div>
</div>


<!-- end main content-->

<!-- END layout-wrapper -->
<div th:replace="admin/fragments/themeSettings::themeSettings"></div>
<div th:replace="admin/fragments/script::script"></div>
<!--<img th:src="@{/assets/images/products/img-4.png}" >-->
</body>
<!--<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>-->
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.10.5/sweetalert2.all.min.js"></script>-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script th:inline="javascript">

    const Toast = swal.mixin({
        toast: true,
        position: "top-end",
        iconColor: "white",
        customClass: {
            popup: "colored-toast",
        },
        showConfirmButton: false,
        timer: 1800,
        timerProgressBar: true,
    });

    // lưu page index đang select của table
    var page;

    var idProduct;

    var idProduct_Detail;

    var pageProduct;

    var pageProductDetail;

    var sourceImg;

    let isPictureUploaded = false;

    window.onload = async function () {
        try {
            await loadSelect();
            await loadPage(0);
            // await findDataInSelect();
        } catch (error) {
            console.error('Error during initial loading:', error);
            alert('An error occurred during the initial loading. Please try again.');
        }
    }


    function resetFilter() {
        document.getElementById('sort').value = 'ngayTao,desc';
        document.getElementById('filter-status').value = '-1';
        document.getElementById('filter-category').value = '-1';
        document.getElementById('filter-trademark').value = '-1';
        document.getElementById('search-product-input').value = '';

        loadPage(0);
    }

    window.onload = async function () {
        await loadSelect();
        loadPage(0);
    };

    async function loadSelect() {
        let urlCategory = '/admin/product/category/getAll';
        let urlTrademark = '/admin/product/trademark/getAll';
        let urlCollar = '/admin/product/collar/getAll';
        let urlShirtTail = '/admin/product/shirtTail/getAll';
        let urlDesigns = '/admin/product/designs/getAll';
        let urlMaterial = '/admin/product/material/getAll';

        try {
            const [responseCategory, responseTrademark, responseCollar, responseShirtTail, responseDesigns, responseMaterial] = await Promise.all([
                fetch(urlCategory, {
                    method: 'GET',
                    headers: {'Authorization': 'Bearer ' + localStorage.getItem("token")}
                }),
                fetch(urlTrademark, {
                    method: 'GET',
                    headers: {'Authorization': 'Bearer ' + localStorage.getItem("token")}
                }),
                fetch(urlCollar, {
                    method: 'GET',
                    headers: {'Authorization': 'Bearer ' + localStorage.getItem("token")}
                }),
                fetch(urlShirtTail, {
                    method: 'GET',
                    headers: {'Authorization': 'Bearer ' + localStorage.getItem("token")}
                }),
                fetch(urlDesigns, {
                    method: 'GET',
                    headers: {'Authorization': 'Bearer ' + localStorage.getItem("token")}
                }),
                fetch(urlMaterial, {
                    method: 'GET',
                    headers: {'Authorization': 'Bearer ' + localStorage.getItem("token")}
                })
            ]);

            if (!responseCategory.ok || !responseTrademark.ok || !responseCollar.ok || !responseShirtTail.ok || !responseDesigns.ok || !responseMaterial.ok) {
                throw new Error('Failed to fetch data');
            }

            const [listCategory, listTrademark, listCollar, listShirtTail, listDesigns, listMaterial] = await Promise.all([
                responseCategory.json(),
                responseTrademark.json(),
                responseCollar.json(),
                responseShirtTail.json(),
                responseDesigns.json(),
                responseMaterial.json()
            ]);

            let categoryOptions = `<option selected value="-1">Chọn danh mục</option>`;
            let trademarkOptions = `<option selected value="-1">Chọn thương hiệu</option>`;
            let collarOptions = `<option selected value="-1">Chọn cổ áo</option>`;
            let shirtTailOptions = `<option selected value="-1">Chọn đuôi áo</option>`;
            let designsOptions = `<option selected value="-1">Chọn thiết kế</option>`;
            let materialOptions = `<option selected value="-1">Chọn chất liệu</option>`;

            listCategory.forEach(item => categoryOptions += `<option value="${item.id}">${item.ten}</option>`);
            listTrademark.forEach(item => trademarkOptions += `<option value="${item.id}">${item.ten}</option>`);
            listCollar.forEach(item => collarOptions += `<option value="${item.id}">${item.ten}</option>`);
            listShirtTail.forEach(item => shirtTailOptions += `<option value="${item.id}">${item.ten}</option>`);
            listDesigns.forEach(item => designsOptions += `<option value="${item.id}">${item.ten}</option>`);
            listMaterial.forEach(item => materialOptions += `<option value="${item.id}">${item.ten}</option>`);

            document.getElementById('product-category-update-input').innerHTML = categoryOptions;
            document.getElementById('product-brand-update-input').innerHTML = trademarkOptions;
            document.getElementById('product-collar-update-input').innerHTML = collarOptions;
            document.getElementById('product-shirtTail-update-input').innerHTML = shirtTailOptions;
            document.getElementById('product-designs-update-input').innerHTML = designsOptions;
            document.getElementById('product-material-update-input').innerHTML = materialOptions;

        } catch (error) {
            console.error('Error:', error);
        }
    }

    function previewImageProductDetail(event) {
        var imagePreviewContainer = document.getElementById('image-preview-container-productDetail');
        imagePreviewContainer.innerHTML = '';

        var files = event.target.files;
        var imagePaths = [];

        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            var reader = new FileReader();
            reader.onload = (function (file) {
                return function (e) {
                    var imgElement = document.createElement('img');
                    imgElement.src = e.target.result;
                    imgElement.className = 'avatar-md rounded bg-light';
                    imagePreviewContainer.appendChild(imgElement);

                    imagePaths.push(file.name);
                    document.getElementById('image-path-input').value = imagePaths.join(',');
                };
            })(file);
            reader.readAsDataURL(file);
        }
    }

    function previewImageProductDetailEdit(event) {
        var imagePreviewContainer = document.getElementById('image-preview-container-productDetail-edit');
        imagePreviewContainer.innerHTML = '';

        var files = event.target.files;
        var imagePaths = [];

        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            var reader = new FileReader();
            reader.onload = (function (file) {
                return function (e) {
                    var imgElement = document.createElement('img');
                    imgElement.src = e.target.result;
                    imgElement.className = 'avatar-md rounded bg-light';
                    imagePreviewContainer.appendChild(imgElement);

                    imagePaths.push(file.name);
                    document.getElementById('image-path-input-edit').value = imagePaths.join(',');
                };
            })(file);
            reader.readAsDataURL(file);
        }
    }

    function previewImgProductEdit(event) {
        var imagePreviewContainer = document.getElementById('image-preview-productImgEdit');
        imagePreviewContainer.innerHTML = '';

        var files = event.target.files;
        var imagePaths = [];

        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            var reader = new FileReader();
            reader.onload = (function (file) {
                return function (e) {
                    var imgElement = document.createElement('img');
                    imgElement.src = e.target.result;
                    imgElement.className = 'avatar-md rounded bg-light';
                    imagePreviewContainer.appendChild(imgElement);

                    imagePaths.push(file.name);
                    document.getElementById('image-path-productEdit').value = imagePaths.join(',');
                };
            })(file);
            reader.readAsDataURL(file);
        }
    }

    // Gọi hàm loadSelect khi trang được tải
    window.onload = async function () {
        await loadSelect();
        loadPage(0);
    };

    async function findDataInSelect() {
        let urls = {
            urlTrademark: '/admin/product/trademark/getAll',
            urlCategory: '/admin/product/category/getAll',
            urlCollar: '/admin/product/collar/getAll',
            urlShirtTail: '/admin/product/shirtTail/getAll',
            urlDesigns: '/admin/product/designs/getAll',
            urlMaterial: '/admin/product/material/getAll',
        };

        try {
            const [responseTrademark, responseCategory, responseCollar, responseShirtTail, responseDesigns, responseMaterial] = await Promise.all(
                Object.values(urls).map(url => fetch(url, {
                    method: 'GET',
                    headers: {'Authorization': 'Bearer ' + localStorage.getItem("token")}
                }))
            );

            if (!responseTrademark.ok) throw new Error('Failed to fetch trademarks');
            if (!responseCategory.ok) throw new Error('Failed to fetch categories');
            if (!responseCollar.ok) throw new Error('Failed to fetch collars');
            if (!responseShirtTail.ok) throw new Error('Failed to fetch shirt tails');
            if (!responseDesigns.ok) throw new Error('Failed to fetch designs');
            if (!responseMaterial.ok) throw new Error('Failed to fetch materials');

            const [listTrademark, listCategory, listCollar, listShirtTail, listDesigns, listMaterial] = await Promise.all([
                responseTrademark.json(),
                responseCategory.json(),
                responseCollar.json(), // Lấy danh sách cổ áo
                responseShirtTail.json(),
                responseDesigns.json(),
                responseMaterial.json()
            ]);

            let options = {
                trademarkOptions: '<option selected value="-1">-----</option>',
                categoryOptions: '<option selected value="-1">-----</option>',
                collarOptions: '<option selected value="-1">-----</option>',
                shirtTailOptions: '<option selected value="-1">-----</option>',
                designsOptions: '<option selected value="-1">-----</option>',
                materialOptions: '<option selected value="-1">-----</option>',
            };

            listTrademark.forEach(item => options.trademarkOptions += `<option value="${item.id}">${item.ten}</option>`);
            listCategory.forEach(item => options.categoryOptions += `<option value="${item.id}">${item.ten}</option>`);
            listCollar.forEach(item => options.collarOptions += `<option value="${item.id}">${item.ten}</option>`);
            listShirtTail.forEach(item => options.shirtTailOptions += `<option value="${item.id}">${item.ten}</option>`);
            listDesigns.forEach(item => options.designsOptions += `<option value="${item.id}">${item.ten}</option>`);
            listMaterial.forEach(item => options.materialOptions += `<option value="${item.id}">${item.ten}</option>`);

            document.getElementById('product-brand-update-input').innerHTML = options.trademarkOptions;
            document.getElementById('product-category-update-input').innerHTML = options.categoryOptions;
            document.getElementById('product-collar-update-input').innerHTML = options.collarOptions;
            document.getElementById('product-shirtTail-update-input').innerHTML = options.shirtTailOptions;
            document.getElementById('product-designs-update-input').innerHTML = options.designsOptions;
            document.getElementById('product-material-update-input').innerHTML = options.materialOptions;

        } catch (error) {
            console.error('Error:', error);
            alert('There was an error loading data. Please try again later.');
        }
    }

    async function detailProduct(productId) {
        await findDataInSelect();
        try {
            idProduct = productId;
            const response = await fetch('/admin/product/detail/' + productId, {
                method: 'GET',
                headers: {'Authorization': 'Bearer ' + localStorage.getItem("token")}
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();
            console.log('Product details fetched:', data);

            if (!data.id || !data.ten) {
                throw new Error('Invalid product data structure');
            }

            document.getElementById('product-name-update-input').value = data.ten;
            document.getElementById('product-price-update-input').value = data.gia;
            // document.getElementById('product-priceSale-update-input').value = data.giaSale;
            // document.getElementById('product-quantity-update-input').value = data.soLuong;
            document.getElementById('product-description-update-input').value = data.moTa;


            if (data.trangThai === 1) {
                document.getElementById('radioStatus1').checked = true;
            } else if (data.trangThai === 0) {
                document.getElementById('radioStatus2').checked = true;
            }


            // Thiết lập giá trị cho các thẻ select
            document.getElementById('product-collar-update-input').value = data.idCoAo.id;
            document.getElementById('product-shirtTail-update-input').value = data.idDuoiAo.id;
            document.getElementById('product-designs-update-input').value = data.idKieuDang.id;
            document.getElementById('product-material-update-input').value = data.idChatLieu.id;
            document.getElementById('product-category-update-input').value = data.idDanhMuc.id;
            document.getElementById('product-brand-update-input').value = data.idThuongHieu.id;


            //Hiển thị hình ảnh hiện tại
            const imagePreviewContainer = document.getElementById('image-preview-productImgEdit');
            imagePreviewContainer.innerHTML = '';
            if (data.duongDan) {
                const imagePaths = data.duongDan.split(',');
                imagePaths.forEach(path => {
                    const imgElement = document.createElement('img');
                    imgElement.src = `/assets/images/products/${path.trim()}`;
                    imgElement.className = 'avatar-md rounded bg-light';
                    imagePreviewContainer.appendChild(imgElement);
                });
                document.getElementById('image-path-productEdit').value = imagePaths.join(',');
            }


            document.getElementById('error-name-update').innerText = '';
            document.getElementById('error-brand-update').innerText = '';
            document.getElementById('error-collar-update').innerText = '';
            document.getElementById('error-category-update').innerText = '';
            document.getElementById('error-price-update').innerText = '';
            // document.getElementById('error-priceSale-update').innerText = '';
            // document.getElementById('error-quantity-update').innerText = '';
            document.getElementById('error-description-update').innerText = '';
            $('#myModal').modal('show');

        } catch (error) {
            console.error('Error:', error);
        }
    }


    async function editProductDetail(idProductDetail) {
        try {
            const response = await fetch('/admin/product_detail/detail/' + idProductDetail, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("token")
                }
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();
            console.log(data);

            if (!data.idSanPham || !data.idSanPham.ten) {
                throw new Error('Invalid data structure');
            }

            idProduct_Detail = idProductDetail;
            document.getElementById('product-name-input-edit').value = data.idSanPham.ten;
            document.getElementById('productdetail-count-input-edit').value = data.soluong;

            const colorId = data.idMauSac.id;
            const sizeId = data.idSize.id;
            const trangThai = data.trangThai;

            await loadColors(colorId);
            await loadSizes(sizeId);

            const radioStatus1 = document.getElementById('update-RadioStatus1');
            const radioStatus2 = document.getElementById('update-RadioStatus2');

            if (radioStatus1 && radioStatus2) {
                if (trangThai === 1) {
                    radioStatus1.checked = true;
                } else {
                    radioStatus2.checked = true;
                }
            } else {
                console.error('Radio buttons for status not found.');
            }

            // Show current images
            const imagePreviewContainer = document.getElementById('image-preview-container-productDetail-edit');
            imagePreviewContainer.innerHTML = '';
            if (data.duongDan) {
                const imagePaths = data.duongDan.split(',');
                imagePaths.forEach(path => {
                    const imgElement = document.createElement('img');
                    imgElement.src = `/assets/images/products/${path.trim()}`;
                    imgElement.className = 'avatar-md rounded bg-light';
                    imagePreviewContainer.appendChild(imgElement);
                });
                document.getElementById('image-path-input-edit').value = imagePaths.join(',');
            }

            $('#myModalEdit').modal('show');
            $('#myModalTable').modal('hide');
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function selectStatusUpdate(option) {
        if (option === 1) {
            document.getElementById('update-RadioStatus1').checked = true;
            document.getElementById('update-RadioStatus2').checked = false;
        } else {
            document.getElementById('update-RadioStatus2').checked = true;
            document.getElementById('update-RadioStatus1').checked = false;
        }

    }


    async function showConfirmPopupUpdate() {
        try {
            const productDetailData = {
                soluong: document.getElementById('productdetail-count-input-edit').value,
                mauSac: document.getElementById('color-select-edit').value,
                size: document.getElementById('size-select-edit').value,
                trangThai: parseInt(document.querySelector('input[name="trangThai"]').value),
                duongDan: document.getElementById('image-path-input-edit').value
            };

            if (!productDetailData.soluong || productDetailData.soluong <= 0) {
                Swal.fire({
                    icon: "warning",
                    title: "Vui lòng nhập số lượng hợp lệ!",
                    confirmButtonText: "OK"
                });
                return;
            }

            if (!productDetailData.mauSac) {
                Swal.fire({
                    icon: "warning",
                    title: "Vui lòng chọn màu sắc!",
                    confirmButtonText: "OK"
                });
                return;
            }

            if (!productDetailData.size) {
                Swal.fire({
                    icon: "warning",
                    title: "Vui lòng chọn kích thước!",
                    confirmButtonText: "OK"
                });
                return;
            }

            const result = await Swal.fire({
                icon: 'question',
                title: "Lưu các thay đổi?",
                showCancelButton: true,
                confirmButtonText: "Có",
                cancelButtonText: "Không"
            });

            if (!result.isConfirmed) {
                return;
            }

            const response = await fetch('/admin/product_detail/update/' + idProduct_Detail, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem("token")
                },
                body: JSON.stringify(productDetailData)
            });

            const responseData = await response.json();

            if (response.ok) {
                if (responseData.message === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: "Cập nhật thành công!",
                        confirmButtonText: "OK"
                    }).then(() => {
                        loadPage(page);
                        viewProductDetail(idProduct, pageProductDetail);
                        $('#myModalEdit').modal('hide');
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: responseData.message,
                        confirmButtonText: "OK"
                    });
                }
            } else {
                throw new Error(responseData.message);
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Đã xảy ra lỗi. Vui lòng thử lại!',
                confirmButtonText: "OK"
            });
        }
    }

    async function loadColors(selectedColorId) {
        try {
            const response = await fetch('/admin/product/color/getAll', {
                method: 'GET',
                headers: {'Authorization': 'Bearer ' + localStorage.getItem("token")}
            });
            const data = await response.json();
            const colorSelect = document.getElementById("color-select-edit");
            colorSelect.innerHTML = '';
            data.forEach(color => {
                const option = document.createElement("option");
                option.value = color.id;
                option.text = color.ten;
                if (color.id === selectedColorId) {
                    option.selected = true;
                }
                colorSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading colors:', error);
        }
    }

    async function loadSizes(selectedSizeId) {
        try {
            const response = await fetch('/admin/product/size/getAll', {
                method: 'GET',
                headers: {'Authorization': 'Bearer ' + localStorage.getItem("token")}
            });
            const data = await response.json();
            const sizeSelect = document.getElementById("size-select-edit");
            sizeSelect.innerHTML = '';
            data.forEach(size => {
                const option = document.createElement("option");
                option.value = size.id;
                option.text = size.ten;
                if (size.id === selectedSizeId) {
                    option.selected = true;
                }
                sizeSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading sizes:', error);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        loadColors();
        loadSizes();
    });


    $('#myModalEdit').on('hidden.bs.modal', function (e) {
        $('#myModalTable').modal('show');
    });


    function getDataFromForm() {

        var ten = document.getElementById('product-name-update-input').value;
        var duongDan = document.getElementById('image-path-productEdit').value;
        var thuongHieu = document.getElementById('product-brand-update-input').value;
        var danhMuc = document.getElementById('product-category-update-input').value;
        var trangThai = document.querySelector('input[name="status-update"]:checked').value;
        var coAo = document.getElementById('product-collar-update-input').value;
        var gia = document.getElementById('product-price-update-input').value;
        // var giaSale = document.getElementById('product-priceSale-update-input').value;
        var duoiAo = document.getElementById('product-shirtTail-update-input').value;
        var kieuDang = document.getElementById('product-designs-update-input').value;
        var chatLieu = document.getElementById('product-material-update-input').value;
        var moTa = document.getElementById('product-description-update-input').value;

        var formData = {
            ten: ten,
            duongDan: duongDan,
            thuongHieu: thuongHieu,
            danhMuc: danhMuc,
            trangThai: trangThai,
            coAo: coAo,
            gia: gia,
            // giaSale: giaSale,
            duoiAo: duoiAo,
            kieuDang: kieuDang,
            chatLieu: chatLieu,
            moTa: moTa
        };

        return formData;
    }

    function showConfirmPopup() {
        var data = getDataFromForm();
        var isValid = 0;
        var regex = /^[A-Za-z]/;

        if (data.ten === '') {
            document.getElementById('error-name-update').innerText = 'Vui lòng điền tên!';
            isValid += 1;
        }
        if (data.gia === '') {
            document.getElementById('error-price-update').innerText = 'Vui lòng điền đơn giá!';
            isValid += 1;
        }

        if (isValid === 0) {
            swal.fire({
                icon: 'question',
                title: "Lưu các thay đổi?",
                showCancelButton: true,
                confirmButtonText: "Có",
                cancelButtonText: 'Không'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/admin/product/update/' + idProduct,
                        method: 'POST',
                        contentType: 'application/json',
                        headers: {'Authorization': 'Bearer ' + localStorage.getItem("token")},
                        data: JSON.stringify(data),
                        success: function (response) {
                            if (response === 'success') {
                                swal.fire({
                                    icon: 'success',
                                    title: "Cập nhật thành công!",
                                    confirmButtonText: "Ok",
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        loadPage(page);
                                        $('#myModal').modal('hide');
                                    }
                                });
                            } else {
                                response.forEach(item => {
                                    if (item.statusText === 'failure') {
                                        if (item.message === 'errorFormatName') {
                                            if (regex.test(data.ten)) {
                                                Toast.fire({
                                                    icon: "error",
                                                    title: "Tên tối thiếu 4 kí tự,tối đa 50 kí tự!",
                                                });
                                            } else {
                                                Toast.fire({
                                                    icon: "error",
                                                    title: "Tên phải bắt đầu bằng chữ!",
                                                });
                                            }
                                        }
                                        if (item.message === 'errorDuplicateName') {
                                            Toast.fire({
                                                icon: "error",
                                                title: "Tên sản phẩm đã tồn tại!",
                                            });
                                        }
                                        if (item.message === 'errorPriceLessThan') {
                                            Toast.fire({
                                                icon: "error",
                                                title: "Đơn giá không dưới 0!",
                                            });
                                        }
                                    }
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error:', error);
                        }
                    });
                }
            });
        }
    }


    document.addEventListener("DOMContentLoaded", function () {
        loadColors();
        loadSizes();
    });

    // Hàm để làm mới nội dung của các thẻ select
    function refreshSelects() {
        var colorSelect = document.getElementById("product-color-detail-input");
        var sizeSelect = document.getElementById("product-size-detail-input");
        colorSelect.innerHTML = ''; // Xóa nội dung cũ
        sizeSelect.innerHTML = '';
        loadColorsAddDetail();
        loadSizesAddDetail();
    }

    // Gọi hàm refreshSelects khi modal được mở
    $('#myModalView').on('shown.bs.modal', function () {
        refreshSelects();
    });

    function loadColorsAddDetail() {
        $.ajax({
            url: '/admin/product/color/getAll', // URL để lấy dữ liệu màu sắc
            method: 'GET',
            success: function (response) {
                // console.log('color:' + JSON.stringify(response));
                var colorSelect = document.getElementById("product-color-detail-input");
                response.forEach(function (color) {
                    var option = document.createElement("option");
                    option.value = color.id;
                    option.text = color.ten; // Đảm bảo thuộc tính này đúng với dữ liệu trả về từ API
                    colorSelect.appendChild(option);
                });
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
            }
        });
    }

    function loadSizesAddDetail() {
        $.ajax({
            url: '/admin/product/size/getAll', // URL để lấy dữ liệu kích thước
            method: 'GET',
            success: function (response) {
                // console.log('size:' + JSON.stringify(response));
                var sizeSelect = document.getElementById("product-size-detail-input");
                response.forEach(function (size) {
                    var option = document.createElement("option");
                    option.value = size.id;
                    option.text = size.ten; // Đảm bảo thuộc tính này đúng với dữ liệu trả về từ API
                    sizeSelect.appendChild(option);
                });
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
            }
        });
    }

    function showConfirmPopupSave() {
        var count = document.getElementById("product-detail-count-input").value;
        var spct;
        var selectedColors = [];
        var selectedSizes = [];
        var trangThai = document.querySelector('input[name="trangThai"]:checked').value;
        var colorSelect = document.getElementById("product-color-detail-input");
        for (var i = 0; i < colorSelect.options.length; i++) {
            if (colorSelect.options[i].selected) {
                selectedColors.push(colorSelect.options[i].value);
            }
        }

        var sizeSelect = document.getElementById("product-size-detail-input");
        for (var i = 0; i < sizeSelect.options.length; i++) {
            if (sizeSelect.options[i].selected) {
                selectedSizes.push(sizeSelect.options[i].value);
            }
        }

        var duongDan = document.getElementById('image-path-input').value;

        if (count === '') {
            swal.fire({
                icon: "warning",
                title: "Bạn Chưa Nhập Số Lượng Sản Phẩm?",
                confirmButtonText: "OK"
            });
        } else if (isNaN(count)) {
            swal.fire({
                icon: "warning",
                title: "Hãy nhập đúng số lượng!",
                confirmButtonText: "OK"
            });
        } else if (count <= 0 || count >= 2000) {
            swal.fire({
                icon: "warning",
                title: "Số lượng phải lớn hơn 0 và bé hơn 2000!",
                confirmButtonText: "OK"
            });
        } else if (selectedColors.length === 0) {
            swal.fire({
                icon: "warning",
                title: "Bạn Chưa Chọn Màu Sắc?",
                confirmButtonText: "OK"
            });
        } else if (selectedSizes.length === 0) {
            swal.fire({
                icon: "warning",
                title: "Bạn Chưa Chọn Size?",
                confirmButtonText: "OK"
            });
        } else {
            swal.fire({
                icon: 'question',
                title: "Bạn Có Muốn Thêm Mới?",
                showCancelButton: true,
                confirmButtonText: "Có",
                cancelButtonText: "Không"
            }).then((result) => {
                if (result.isConfirmed) {
                    var productArray = [];

                    selectedColors.forEach(color => {
                        selectedSizes.forEach(size => {
                            spct = {
                                soluong: count,
                                mauSac: color,
                                size: size,
                                duongDan: duongDan,
                                trangThai: trangThai
                            };
                            productArray.push(spct);
                        });
                    });

                    $.ajax({
                        url: '/admin/product/save_product_detail/validation/' + idProduct,
                        method: 'POST',
                        contentType: 'application/json',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem("token")
                        },
                        data: JSON.stringify(productArray),
                        success: function (response) {
                            var countIsValid = {
                                true: 0,
                                false: 0
                            };

                            response.forEach(function (item) {
                                if (item.valid === true) {
                                    countIsValid.true++;
                                } else {
                                    countIsValid.false++;
                                }
                            });

                            if (countIsValid.true > 0 && countIsValid.false === 0) {
                                swal.fire({
                                    icon: "error",
                                    title: "Các Sản Phẩm Bạn Muốn Thêm Đã Tồn Tại!",
                                    text: "Vui Lòng Kiểm Tra Và Thử Lại!",
                                    showCancelButton: true
                                });
                            } else if (countIsValid.true > 0 && countIsValid.false > 0) {
                                swal.fire({
                                    icon: "error",
                                    title: "Có " + countIsValid.true + " Sản Phẩm Bạn Muốn Thêm Đã Tồn Tại!",
                                    text: "Vui Lòng Kiểm Tra Và Thử Lại!",
                                    showCancelButton: true
                                });
                            } else if (countIsValid.true === 0 && countIsValid.false > 0) {
                                $.ajax({
                                    url: '/admin/product/save_product_detail/save/' + idProduct,
                                    method: 'POST',
                                    contentType: 'application/json',
                                    headers: {
                                        'Authorization': 'Bearer ' + localStorage.getItem("token")
                                    },
                                    data: JSON.stringify(response),
                                    success: function (response) {
                                        if (response === "success") {
                                            swal.fire({
                                                icon: "success",
                                                title: "Thêm Thành Công!",
                                                confirmButtonText: "Ok"
                                            });
                                            viewProductDetail(idProduct, 0);
                                            colorSelect.selectedIndex = -1;
                                            sizeSelect.selectedIndex = -1;
                                            document.getElementById('product-detail-count-input').value = '';
                                            $('#myModalView').modal('hide');
                                            loadPage(page);
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        console.error('Error:', error);
                                    }
                                });
                            } else if (countIsValid.true === 0 && countIsValid.false === 0) {
                                $.ajax({
                                    url: '/admin/product/save_product_detail/save/' + idProduct,
                                    method: 'POST',
                                    contentType: 'application/json',
                                    headers: {
                                        'Authorization': 'Bearer ' + localStorage.getItem("token")
                                    },
                                    data: JSON.stringify(productArray),
                                    success: function (response) {
                                        if (response === "success") {
                                            swal.fire({
                                                icon: "success",
                                                title: "Thêm Thành Công!",
                                                confirmButtonText: "Ok"
                                            });
                                            // Xóa hình ảnh đã chọn
                                            document.getElementById('product-image-input').value = '';
                                            document.getElementById('image-preview-container-productDetail').innerHTML = '';
                                            document.getElementById('image-path-input').value = '';

                                            viewProductDetail(idProduct, 0);
                                            colorSelect.selectedIndex = -1;
                                            sizeSelect.selectedIndex = -1;
                                            document.getElementById('product-detail-count-input').value = '';
                                            $('#myModalView').modal('hide');
                                            loadPage(page);
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        console.error('Error:', error);
                                    }
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error:', error);
                        }
                    });
                }
            });
        }
    }

    window.onload = function () {
        loadPage(0);
    }

    async function loadPage(pageNumber = 0, pageSize = 3) {
        try {
            const response = await fetch(`http://localhost:8080/admin/product/list?page=${pageNumber}&size=${pageSize}`);
            if (!response.ok) {
                throw new Error(`Lỗi HTTP! trạng thái: ${response.status}`);
            }

            const result = await response.json();
            // console.log('Kết quả trả về từ API:', JSON.stringify(result, null, 2));
            const list = result.content;

            if (!Array.isArray(list)) {
                throw new Error('Cấu trúc dữ liệu không hợp lệ: list không phải là một mảng');
            }

            for (let i = 0; i < list.length; i++) {
                var urlDetailTSL = `/admin/product_detail/detailTSL/${list[i].id}`;
                const responseDetailPD = await fetch(urlDetailTSL, {
                    method: 'GET',
                });

                if (!responseDetailPD.ok) {
                    throw new Error(`Lỗi khi lấy chi tiết sản phẩm: ${responseDetailPD.status}`);
                }

                const data = await responseDetailPD.json();
                // console.log(`Chi tiết sản phẩm cho ID ${list[i].id}:`, data); // Log chi tiết sản phẩm

                let quantity = 0;
                if (Array.isArray(data) && data.length > 0) {
                    for (let j = 0; j < data.length; j++) {
                        if (typeof data[j].soluong === 'number') {
                            quantity += data[j].soluong;
                        } else {
                            console.warn(`Số lượng không hợp lệ cho sản phẩm ID: ${list[i].id}, Giá trị: ${data[j].soluong}`);
                        }
                    }
                }
                list[i].soLuong = quantity;
            }

            let main = '';
            list.forEach((item, index) => {
                // console.log(item);
                var hinhAnh = item.duongDan;
                if (hinhAnh != null) {
                    hinhAnh = hinhAnh.split(",");
                    for (let i = 0; i < hinhAnh.length; i++) {
                        hinhAnh[i] = hinhAnh[i].replace("public", "");
                    }
                }
                if (hinhAnh == null) {
                    hinhAnh = "https://via.placeholder.com/150";
                    hinhAnh = "<img src='" + hinhAnh + "' alt='product-img' class='avatar-md rounded bg-light'>";
                } else {
                    hinhAnh = hinhAnh[0];
                    hinhAnh = "<img src='http://localhost:8080/assets/images/products/" + hinhAnh + "' alt='product-img' class='avatar-md rounded bg-light'>";
                }
                main += `<tr>
                <td>${item.id}</td>
                <td>${item.ma}</td>
                <td>${item.ten}</td>

                <td>
                    <div class="d-flex g-0">
                    ${hinhAnh}
                    </div>
                </td>
                <td>${item.soLuong}</td>
                <td>${item.ngayTao}</td>
                <td>${item.gia}</td>
                <td>${item.tenDanhMuc}</td>
                <td>${item.tenThuongHieu}</td>
                <td>${item.trangThai == 1 ? "Đang mở bán" : "Chưa mở bán"}</td>
                <td>
                    <div class="hstack gap-3 flex-warp">
                        <div onclick="viewProductDetail(${item.id})" class="ri-eye-2-line"></div>
                        <div onclick="detailProduct(${item.id})" class="link-info fs-15"><i class="ri-edit-2-line"></i></div>
                    </div>
                </td>
            </tr>`;
            });
            document.getElementById("list_Product").innerHTML = main;

            // Generate pagination
            let totalPages = result.totalPages;
            let pagination = `<div class="pagination-wrap hstack gap-2">
            <button class="page-item pagination-prev" id="pagination-prev" onclick="loadPage(${pageNumber - 1})" ${pageNumber === 0 ? 'disabled' : ''}>
                <i class="mdi mdi-chevron-left align-middle ms-1"></i>
            </button>
            <ul class="pagination">`;

            for (let i = 0; i < totalPages; i++) {
                pagination += `<li class="page-item ${i === pageNumber ? 'active' : ''}"><a class="page-link" onclick="loadPage(${i})">${i + 1}</a></li>`;
            }

            pagination += `</ul>
            <button class="page-item pagination-next" id="pagination-next" onclick="loadPage(${pageNumber + 1})" ${pageNumber + 1 >= totalPages ? 'disabled' : ''}>
                <i class="mdi mdi-chevron-right align-middle ms-1"></i>
            </button>
        </div>`;

            document.getElementById("pagination").innerHTML = pagination;

        } catch (error) {
            console.error('Lỗi khi tải trang:', error);
            document.getElementById("list_Product").innerHTML = `<tr><td colspan="10">Lỗi khi tải dữ liệu: ${error.message}</td></tr>`;
        }
    }

    async function searchProductByNameOrCode(pageNumber) {
        var keyword = document.getElementById("search-product-input").value.trim().toLowerCase();
        var url;
        console.log(keyword);
        console.log(pageNumber);

        var page = pageNumber === undefined ? 0 : pageNumber;

        if (keyword === '') {
            loadPage(0);
            return;
        } else {
            var encodedKeyword = encodeURIComponent(keyword);
            url = "/admin/product/page/search/" + page + "/" + encodedKeyword;
        }

        console.log(url);

        try {
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            });

            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
            }

            const result = await response.json();
            console.log(result);

            // Kiểm tra và log toàn bộ cấu trúc dữ liệu trả về
            console.log('Full response data:', result);

            var list = result.content;
            var totalPage = (result.totalPages !== undefined && !isNaN(parseInt(result.totalPages, 10))) ? parseInt(result.totalPages, 10) : NaN;
            var number = (result.number !== undefined && !isNaN(parseInt(result.number, 10))) ? parseInt(result.number, 10) : NaN;
            var main = '';


            for (let i = 0; i < list.length; i++) {

                let imagePath = "https://via.placeholder.com/150"; // Default image path
                if (list[i].duongDan) {
                    let imagePaths = list[i].duongDan.split(",").map(path => path.replace("public", "").trim());
                    if (imagePaths.length > 0) {
                        imagePath = `http://localhost:8080/assets/images/products/${imagePaths[0]}`;
                    }
                }

                for (let i = 0; i < list.length; i++) {
                    var urlDetailTSL = `/admin/product_detail/detailTSL/${list[i].id}`;
                    const responseDetailPD = await fetch(urlDetailTSL, {
                        method: 'GET',
                    });

                    if (!responseDetailPD.ok) {
                        throw new Error(`Lỗi khi lấy chi tiết sản phẩm: ${responseDetailPD.status}`);
                    }

                    const data = await responseDetailPD.json();
                    // console.log(`Chi tiết sản phẩm cho ID ${list[i].id}:`, data); // Log chi tiết sản phẩm

                    let quantity = 0;
                    if (Array.isArray(data) && data.length > 0) {
                        for (let j = 0; j < data.length; j++) {
                            if (typeof data[j].soluong === 'number') {
                                quantity += data[j].soluong;
                            } else {
                                console.warn(`Số lượng không hợp lệ cho sản phẩm ID: ${list[i].id}, Giá trị: ${data[j].soluong}`);
                            }
                        }
                    }
                    list[i].soLuong = quantity;
                }

                let danhMuc = list[i].idDanhMuc ? list[i].idDanhMuc.ten : '';
                let thuongHieu = list[i].idThuongHieu ? list[i].idThuongHieu.ten : '';

                main += `<tr>
                <td scope="row">${list[i].id}</td>
                <td><strong>${list[i].ma}</strong></td>
                <td><strong>${list[i].ten}</strong></td>
                 <td>
                    <div class="d-flex g-0">
                        <img src="${imagePath}" alt="product-img" class="avatar-md rounded bg-light">
                    </div>
                </td>
                <td>${list[i].soLuong}</td>
                <td>${list[i].ngayTao}</td>
                <td>${list[i].gia}</td>
                <td>${danhMuc}</td>
                <td>${thuongHieu}</td>
                <td>${list[i].trangThai == 1 ? 'Đang mở bán' : 'Chưa mở bán'}</td>
                <td>
                    <div class="hstack gap-3 flex-warp">
                        <div onclick="viewProductDetail(${list[i].id})" class="ri-eye-2-line"></div>
                        <div onclick="detailProduct(${list[i].id})" class="link-info fs-15">
                            <i class="ri-edit-2-line"></i>
                        </div>
                    </div>
                </td>
            </tr>`;
            }
            document.getElementById("list_Product").innerHTML = main;

            if (!isNaN(number) && !isNaN(totalPage)) {
                var currentPage = `<div class="pagination-wrap hstack gap-2">
                <button class="page-item pagination-prev" id="pagination-prev" onclick="searchProductByNameOrCode(${number - 1 < 0 ? totalPage - 1 : number - 1})">
                    <i class="mdi mdi-chevron-left align-middle ms-1"></i>
                </button>
                <ul class="pagination listjs-pagination mb-0">`;

                for (let i = 0; i < totalPage; i++) {
                    currentPage += `<li class="${i === number ? 'active' : ''}"><a class="page" onclick="searchProductByNameOrCode(${i})">${i + 1}</a></li>`;
                }

                currentPage += `</ul>
                <button class="page-item pagination-next" id="pagination-next" onclick="searchProductByNameOrCode(${number + 1 >= totalPage ? 0 : number + 1})">
                    <i class="mdi mdi-chevron-right align-middle ms-1"></i></button>
                </div>`;
                document.getElementById("pagination").innerHTML = currentPage;
            } else {
                console.error('Invalid pagination data:', {number, totalPage});
                alert('Dữ liệu phân trang không hợp lệ. Vui lòng kiểm tra lại.');
            }
        } catch (error) {
            console.error('Error during fetch:', error);
            alert('Có lỗi xảy ra trong quá trình tìm kiếm. Vui lòng thử lại sau.');
        }
    }

    async function sorted(pageNumber = 0, pageSize = 3) {
        const sortSelect = document.getElementById("sort");
        const sortValue = sortSelect.value.split(',');
        const sortField = sortValue[0];
        const sortDirection = sortValue[1];

        console.log(`Sorting by: ${sortField} ${sortDirection}`);


        const url = `/admin/product/sorted?page=${pageNumber}&size=${pageSize}&sort=${sortField},${sortDirection}`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Lỗi HTTP! trạng thái: ${response.status}`);
            }

            const result = await response.json();

            // Kiểm tra nếu result.content là một mảng
            if (Array.isArray(result.content)) {
                const list = result.content;

                for (let i = 0; i < list.length; i++) {
                    var urlDetailTSL = `/admin/product_detail/detailTSL/${list[i].id}`;
                    const responseDetailPD = await fetch(urlDetailTSL, {
                        method: 'GET',
                    });

                    if (!responseDetailPD.ok) {
                        throw new Error(`Lỗi khi lấy chi tiết sản phẩm: ${responseDetailPD.status}`);
                    }

                    const data = await responseDetailPD.json();
                    // console.log(`Chi tiết sản phẩm cho ID ${list[i].id}:`, data); // Log chi tiết sản phẩm

                    let quantity = 0;
                    if (Array.isArray(data) && data.length > 0) {
                        for (let j = 0; j < data.length; j++) {
                            if (typeof data[j].soluong === 'number') {
                                quantity += data[j].soluong;
                            } else {
                                console.warn(`Số lượng không hợp lệ cho sản phẩm ID: ${list[i].id}, Giá trị: ${data[j].soluong}`);
                            }
                        }
                    }
                    list[i].soLuong = quantity;
                }
                let main = '';

                list.forEach(item => {
                    let hinhAnh = item.duongDan ? item.duongDan.split(",")[0].replace("public", "") : "https://via.placeholder.com/150";
                    main += `<tr>
                    <td>${item.id}</td>
                    <td>${item.ma}</td>
                    <td>${item.ten}</td>
                    <td><img src="http://localhost:8080/assets/images/products/${hinhAnh}" alt="product-img" class="avatar-md rounded bg-light"></td>
                    <td>${item.soLuong}</td>
                    <td>${item.ngayTao}</td>
                    <td>${item.gia}</td>
                    <td>${item.tenDanhMuc}</td>
                    <td>${item.tenThuongHieu}</td>
                    <td>${item.trangThai == 1 ? "Đang mở bán" : "Chưa mở bán"}</td>
                    <td>
                        <div class="hstack gap-3 flex-warp">
                            <div onclick="viewProductDetail(${item.id})" class="ri-eye-2-line"></div>
                            <div onclick="detailProduct(${item.id})" class="link-info fs-15"><i class="ri-edit-2-line"></i></div>
                        </div>
                    </td>
                </tr>`;
                });

                document.getElementById("list_Product").innerHTML = main;

                let totalPages = result.totalPages;
                let pagination = `<div class="pagination-wrap hstack gap-2">
                <button class="page-item pagination-prev" id="pagination-prev" onclick="sorted(${pageNumber - 1})" ${pageNumber === 0 ? 'disabled' : ''}>
                    <i class="mdi mdi-chevron-left align-middle ms-1"></i>
                </button>
                <ul class="pagination">`;

                for (let i = 0; i < totalPages; i++) {
                    pagination += `<li class="page-item ${i === pageNumber ? 'active' : ''}"><a class="page-link" onclick="sorted(${i})">${i + 1}</a></li>`;
                }

                pagination += `</ul>
                <button class="page-item pagination-next" id="pagination-next" onclick="sorted(${pageNumber + 1})" ${pageNumber + 1 >= totalPages ? 'disabled' : ''}>
                    <i class="mdi mdi-chevron-right align-middle ms-1"></i>
                </button>
            </div>`;

                document.getElementById("pagination").innerHTML = pagination;
            } else {
                console.error('result.content is not an array:', result.content);
            }

        } catch (error) {
            console.error('Lỗi khi tải trang:', error);
            document.getElementById("list_Product").innerHTML = `<tr><td colspan="10">Lỗi khi tải dữ liệu: ${error.message}</td></tr>`;
        }
    }

    async function statusCheck(pageNumber = 0) {
        let status = document.getElementById('filter-status').value;

        let url = (status === '-1') ? `/admin/product/list?page=${pageNumber}&size=3` : `/admin/product/status?page=${pageNumber}&size=3&trangThai=${status}`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (Array.isArray(result.content)) {
                const list = result.content;
                for (let i = 0; i < list.length; i++) {
                    var urlDetailTSL = `/admin/product_detail/detailTSL/${list[i].id}`;
                    const responseDetailPD = await fetch(urlDetailTSL, {
                        method: 'GET',
                    });

                    if (!responseDetailPD.ok) {
                        throw new Error(`Lỗi khi lấy chi tiết sản phẩm: ${responseDetailPD.status}`);
                    }

                    const data = await responseDetailPD.json();
                    // console.log(`Chi tiết sản phẩm cho ID ${list[i].id}:`, data); // Log chi tiết sản phẩm

                    let quantity = 0;
                    if (Array.isArray(data) && data.length > 0) {
                        for (let j = 0; j < data.length; j++) {
                            if (typeof data[j].soluong === 'number') {
                                quantity += data[j].soluong;
                            } else {
                                console.warn(`Số lượng không hợp lệ cho sản phẩm ID: ${list[i].id}, Giá trị: ${data[j].soluong}`);
                            }
                        }
                    }
                    list[i].soLuong = quantity;
                }

                let main = '';
                result.content.forEach(item => {
                    let hinhAnh = item.duongDan ? item.duongDan.split(",")[0].replace("public", "") : "https://via.placeholder.com/150";
                    main += `<tr>
                        <td>${item.id}</td>
                        <td>${item.ma}</td>
                        <td>${item.ten}</td>
                        <td><img src="http://localhost:8080/assets/images/products/${hinhAnh}" alt="product-img" class="avatar-md rounded bg-light"></td>
                        <td>${item.soLuong}</td>
                        <td>${item.ngayTao}</td>
                        <td>${item.gia}</td>
                        <td>${item.tenDanhMuc}</td>
                        <td>${item.tenThuongHieu}</td>
                        <td>${item.trangThai == 1 ? "Đang mở bán" : "Chưa mở bán"}</td>
                        <td>
                            <div class="hstack gap-3 flex-wrap">
                                <div onclick="viewProductDetail(${item.id})" class="ri-eye-2-line"></div>
                                <div onclick="detailProduct(${item.id})" class="link-info fs-15"><i class="ri-edit-2-line"></i></div>
                            </div>
                        </td>
                    </tr>`;
                });
                document.getElementById("list_Product").innerHTML = main;

                let totalPages = result.totalPages;
                let pagination = `<div class="pagination-wrap hstack gap-2">
                    <button class="page-item pagination-prev" id="pagination-prev" onclick="statusCheck(${pageNumber - 1})" ${pageNumber === 0 ? 'disabled' : ''}>
                        <i class="mdi mdi-chevron-left align-middle ms-1"></i>
                    </button>
                    <ul class="pagination">`;

                for (let i = 0; i < totalPages; i++) {
                    pagination += `<li class="page-item ${i === pageNumber ? 'active' : ''}"><a class="page-link" onclick="statusCheck(${i})">${i + 1}</a></li>`;
                }

                pagination += `</ul>
                    <button class="page-item pagination-next" id="pagination-next" onclick="statusCheck(${pageNumber + 1})" ${pageNumber + 1 >= totalPages ? 'disabled' : ''}>
                        <i class="mdi mdi-chevron-right align-middle ms-1"></i>
                    </button>
                </div>`;

                document.getElementById("pagination").innerHTML = pagination;
            } else {
                console.error('result.content is not an array:', result.content);
            }
        } catch (error) {
            console.error('Error fetching products by status:', error);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        loadCategories();  // Tải danh sách danh mục khi trang được tải
    });

    async function loadCategories() {
        try {
            const response = await fetch('/admin/product/category/getAll', {
                method: 'GET',
                headers: {'Authorization': 'Bearer ' + localStorage.getItem("token")}
            });
            if (!response.ok) throw new Error('Failed to fetch categories');

            const categories = await response.json();
            const categorySelect = document.getElementById("filter-category");

            categories.forEach(category => {
                const option = document.createElement("option");
                option.value = category.id;
                option.text = category.ten;
                categorySelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    async function categoryCheck(pageNumber = 0) {
        const selectedCategory = document.getElementById("filter-category").value;

        let url = (selectedCategory === '-1') ? `/admin/product/list?page=${pageNumber}&size=3` : `/admin/product/categoryFilter?page=${pageNumber}&size=3&idDanhMuc=${selectedCategory}`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (Array.isArray(result.content)) {
                const list = result.content;
                for (let i = 0; i < list.length; i++) {
                    const urlDetailTSL = `/admin/product_detail/detailTSL/${list[i].id}`;
                    const responseDetailPD = await fetch(urlDetailTSL, {
                        method: 'GET',
                    });

                    if (!responseDetailPD.ok) {
                        throw new Error(`Lỗi khi lấy chi tiết sản phẩm: ${responseDetailPD.status}`);
                    }

                    const data = await responseDetailPD.json();

                    let quantity = 0;
                    if (Array.isArray(data) && data.length > 0) {
                        for (let j = 0; j < data.length; j++) {
                            if (typeof data[j].soluong === 'number') {
                                quantity += data[j].soluong;
                            } else {
                                console.warn(`Số lượng không hợp lệ cho sản phẩm ID: ${list[i].id}, Giá trị: ${data[j].soluong}`);
                            }
                        }
                    }
                    list[i].soLuong = quantity;
                }

                let main = '';
                result.content.forEach(item => {
                    let hinhAnh = item.duongDan ? item.duongDan.split(",")[0].replace("public", "") : "https://via.placeholder.com/150";
                    main += `<tr>
                    <td>${item.id}</td>
                    <td>${item.ma}</td>
                    <td>${item.ten}</td>
                    <td><img src="http://localhost:8080/assets/images/products/${hinhAnh}" alt="product-img" class="avatar-md rounded bg-light"></td>
                    <td>${item.soLuong}</td>
                    <td>${item.ngayTao}</td>
                    <td>${item.gia}</td>
                    <td>${item.tenDanhMuc}</td>
                    <td>${item.tenThuongHieu}</td>
                    <td>${item.trangThai == 1 ? "Đang mở bán" : "Chưa mở bán"}</td>
                    <td>
                        <div class="hstack gap-3 flex-wrap">
                            <div onclick="viewProductDetail(${item.id})" class="ri-eye-2-line"></div>
                            <div onclick="detailProduct(${item.id})" class="link-info fs-15"><i class="ri-edit-2-line"></i></div>
                        </div>
                    </td>
                </tr>`;
                });
                document.getElementById("list_Product").innerHTML = main;

                let totalPages = result.totalPages;
                let pagination = `<div class="pagination-wrap hstack gap-2">
                <button class="page-item pagination-prev" id="pagination-prev" onclick="categoryCheck(${pageNumber - 1})" ${pageNumber === 0 ? 'disabled' : ''}>
                    <i class="mdi mdi-chevron-left align-middle ms-1"></i>
                </button>
                <ul class="pagination">`;

                for (let i = 0; i < totalPages; i++) {
                    pagination += `<li class="page-item ${i === pageNumber ? 'active' : ''}"><a class="page-link" onclick="categoryCheck(${i})">${i + 1}</a></li>`;
                }

                pagination += `</ul>
                <button class="page-item pagination-next" id="pagination-next" onclick="categoryCheck(${pageNumber + 1})" ${pageNumber + 1 >= totalPages ? 'disabled' : ''}>
                    <i class="mdi mdi-chevron-right align-middle ms-1"></i>
                </button>
            </div>`;

                document.getElementById("pagination").innerHTML = pagination;
            } else {
                console.error('result.content is not an array:', result.content);
            }
        } catch (error) {
            console.error('Error fetching products by category:', error);
        }
    }


    document.addEventListener("DOMContentLoaded", function () {
        loadTrademarks();  // Tải danh sách thương hiệu khi trang được tải
    });

    async function loadTrademarks() {
        try {
            const response = await fetch('/admin/product/trademark/getAll', {
                method: 'GET',
                headers: {'Authorization': 'Bearer ' + localStorage.getItem("token")}
            });
            if (!response.ok) throw new Error('Failed to fetch trademarks');

            const trademarks = await response.json();
            const trademarkSelect = document.getElementById("filter-trademark");

            trademarks.forEach(trademark => {
                const option = document.createElement("option");
                option.value = trademark.id;
                option.text = trademark.ten;
                trademarkSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading trademarks:', error);
        }
    }

    async function trademarkCheck(pageNumber = 0) {
        const selectedTrademark = document.getElementById("filter-trademark").value;

        let url = (selectedTrademark === '-1') ? `/admin/product/list?page=${pageNumber}&size=3` : `/admin/product/trademarkFilter?page=${pageNumber}&size=3&idThuongHieu=${selectedTrademark}`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (Array.isArray(result.content)) {
                const list = result.content;
                for (let i = 0; i < list.length; i++) {
                    const urlDetailTSL = `/admin/product_detail/detailTSL/${list[i].id}`;
                    const responseDetailPD = await fetch(urlDetailTSL, {
                        method: 'GET',
                    });

                    if (!responseDetailPD.ok) {
                        throw new Error(`Lỗi khi lấy chi tiết sản phẩm: ${responseDetailPD.status}`);
                    }

                    const data = await responseDetailPD.json();

                    let quantity = 0;
                    if (Array.isArray(data) && data.length > 0) {
                        for (let j = 0; j < data.length; j++) {
                            if (typeof data[j].soluong === 'number') {
                                quantity += data[j].soluong;
                            } else {
                                console.warn(`Số lượng không hợp lệ cho sản phẩm ID: ${list[i].id}, Giá trị: ${data[j].soluong}`);
                            }
                        }
                    }
                    list[i].soLuong = quantity;
                }

                let main = '';
                result.content.forEach(item => {
                    let hinhAnh = item.duongDan ? item.duongDan.split(",")[0].replace("public", "") : "https://via.placeholder.com/150";
                    main += `<tr>
                    <td>${item.id}</td>
                    <td>${item.ma}</td>
                    <td>${item.ten}</td>
                    <td><img src="http://localhost:8080/assets/images/products/${hinhAnh}" alt="product-img" class="avatar-md rounded bg-light"></td>
                    <td>${item.soLuong}</td>
                    <td>${item.ngayTao}</td>
                    <td>${item.gia}</td>
                    <td>${item.tenDanhMuc}</td>
                    <td>${item.tenThuongHieu}</td>
                    <td>${item.trangThai == 1 ? "Đang mở bán" : "Chưa mở bán"}</td>
                    <td>
                        <div class="hstack gap-3 flex-wrap">
                            <div onclick="viewProductDetail(${item.id})" class="ri-eye-2-line"></div>
                            <div onclick="detailProduct(${item.id})" class="link-info fs-15"><i class="ri-edit-2-line"></i></div>
                        </div>
                    </td>
                </tr>`;
                });
                document.getElementById("list_Product").innerHTML = main;

                let totalPages = result.totalPages;
                let pagination = `<div class="pagination-wrap hstack gap-2">
                <button class="page-item pagination-prev" id="pagination-prev" onclick="trademarkCheck(${pageNumber - 1})" ${pageNumber === 0 ? 'disabled' : ''}>
                    <i class="mdi mdi-chevron-left align-middle ms-1"></i>
                </button>
                <ul class="pagination">`;

                for (let i = 0; i < totalPages; i++) {
                    pagination += `<li class="page-item ${i === pageNumber ? 'active' : ''}"><a class="page-link" onclick="trademarkCheck(${i})">${i + 1}</a></li>`;
                }

                pagination += `</ul>
                <button class="page-item pagination-next" id="pagination-next" onclick="trademarkCheck(${pageNumber + 1})" ${pageNumber + 1 >= totalPages ? 'disabled' : ''}>
                    <i class="mdi mdi-chevron-right align-middle ms-1"></i>
                </button>
            </div>`;

                document.getElementById("pagination").innerHTML = pagination;
            } else {
                console.error('result.content is not an array:', result.content);
            }
        } catch (error) {
            console.error('Error fetching products by trademark:', error);
        }
    }



    function showModalAddProductDetail() {
        console.log(idProduct);
        if (idProduct === null || idProduct === undefined) {
            Swal.fire({
                icon: "warning",
                title: "Hãy Chọn Sản Phẩm Bên Trên!",
            });
        } else {
            fetch('/admin/product/detail/' + idProduct, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("token")
                }
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            }).then(data => {
                console.log(data);
                document.getElementById('product-detail-name-input').value = data.ten;
                $('#myModalView').modal('show');
            })
                .catch(error => console.error('Error:', error));
        }
    }

    async function viewProductDetail(Idproduct, pageNumber) {
        var color = document.getElementById("filter-color").value;
        var size = document.getElementById("filter-size").value;

        var colorName = $('#filter-color :selected').text();

        var baseUrl = `/admin/product/product_detail/${Idproduct}/${pageNumber || 0}?color=${color}&size=${size}`;

        var url = `/admin/product/product_detail/${Idproduct}/0?color=0&size=0`;

        try {
            // Fetch product details to get the product name
            const productResponse = await fetch(`/admin/product/detail/${Idproduct}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("token")
                }
            });

            if (!productResponse.ok) {
                throw new Error('Failed to fetch product details');
            }

            const productData = await productResponse.json();
            document.getElementById('productDetail-name').value = productData.ten || 'N/A';

            const response_check = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("token")
                }
            });

            const checkResult = await response_check.json();
            let checkList = checkResult.content;

            idProduct = Idproduct;
            pageProductDetail = pageNumber;

            const response = await fetch(baseUrl, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("token")
                }
            });

            const result = await response.json();
            const list = result.content;

            const totalPage = result.totalPages;
            const number = result.number;
            let main = '';
            $('#myModalTable').modal('show');

            if (list.length > 0) {
                for (let i = 0; i < list.length; i++) {
                    let id = list[i]?.id || '';
                    let hinhAnh = list[i]?.duongDan;
                    let soluong = list[i]?.soluong || 0;
                    let tenMauSac = list[i]?.idMauSac?.ten || 'N/A';
                    let tenSize = list[i]?.idSize?.ten || 'N/A';

                    if (hinhAnh != null) {
                        hinhAnh = hinhAnh.split(",");
                        for (let j = 0; j < hinhAnh.length; j++) {
                            hinhAnh[j] = hinhAnh[j].replace("public", "");
                        }
                        hinhAnh = `<img src='http://localhost:8080/assets/images/products/${hinhAnh[0]}' alt='product-img' class='avatar-md rounded bg-light'>`;
                    } else {
                        hinhAnh = "<img src='https://via.placeholder.com/150' alt='product-img' class='avatar-md rounded bg-light'>";
                    }

                    main += `<tr>
                    <td scope="row">${id}</td>
                    <td scope="row">${hinhAnh}</td>
                    <td scope="row">${soluong}</td>
                    <td scope="row">${tenMauSac}</td>
                    <td scope="row">${tenSize}</td>
                    <td>
                        <div class="hstack gap-3 flex-warp">
                            <div onclick="editProductDetail(${id})" class="link-info fs-15">
                                <i class="ri-edit-2-line"></i>
                            </div>
                        </div>
                    </td>
                </tr>`;
                }
            } else {
                if (checkList.length === 0) {
                    main = `
                    <tr>
                        <td></td>
                        <td>
                            <div class="form-label">Sản Phẩm Này Chưa Có Sản Phẩm Chi Tiết!</div>
                        </td>
                        <td></td>
                    </tr>`;
                } else if (checkList.length > 0 && color === "0" && size !== "0") {
                    main = `
                    <tr>
                        <td></td>
                        <td>
                            <div class="form-label">Sản Phẩm Này Chưa Có Size ${size} !</div>
                        </td>
                        <td></td>
                    </tr>`;
                } else if (checkList.length > 0 && color !== "0" && size === "0") {
                    main = `
                    <tr>
                        <td></td>
                        <td>
                            <div class="form-label">Sản Phẩm Này Chưa Có Màu ${colorName} !</div>
                        </td>
                        <td></td>
                    </tr>`;
                } else {
                    main = `
                    <tr>
                        <td></td>
                        <td>
                            <div class="form-label">Sản Phẩm Này Chưa Có Màu ${colorName} và Size ${size} !</div>
                        </td>
                        <td></td>
                    </tr>`;
                }
            }

            document.getElementById("list_Product_Detail").innerHTML = main;

            // Tạo nút phân trang
            var currentPage = `<div class="pagination-wrap hstack gap-2">
            <button class="page-item pagination-prev" id="pagination-prev" onclick="viewProductDetail(${Idproduct},${number - 1 < 0 ? totalPage - 1 : number - 1})">
                <i class="mdi mdi-chevron-left align-middle ms-1"></i>
            </button>
            <ul class="pagination listjs-pagination mb-0">`;

            for (let i = 0; i < totalPage; i++) {
                currentPage += `<li class="${i === number ? 'active' : ''}"><a class="page" onclick="viewProductDetail(${Idproduct},${i})">${i + 1}</a></li>`;
            }

            currentPage += `</ul>
            <button class="page-item pagination-next" id="pagination-next" onclick="viewProductDetail(${Idproduct},${number + 1 >= totalPage ? 0 : number + 1})">
                <i class="mdi mdi-chevron-right align-middle ms-1"></i>
            </button>
        </div>`;

            document.getElementById("pagination2").innerHTML = currentPage;

        } catch (error) {
            console.error('Error:', error);
        }
    }


    function formatMoney(money) {
        const VND = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
        });
        return VND.format(money);
    }

    function updateStatus(idProduct, status) {
        let message = ''
        if (status === 1) {
            message = 'Bạn có muốn mở bán cho sản phẩm này?';
        } else {
            message = 'Bạn có muốn mở ngừng bán sản phẩm này?';
        }
        swal.fire({
            icon: 'question',
            title: message,
            showCancelButton: true,
            confirmButtonText: "Lưu",
            cancelButtonText: `Không`
        }).then((result) => {
            if (result.isConfirmed) {

                $.ajax({
                    url: '/api/admin/product/update_status/' + idProduct + '/' + status,
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    success: function (response) {
                        console.log(response)
                        if (response === 'success') {
                            swal.fire({
                                icon: 'success',
                                title: 'Thông Báo',
                                text: 'Cập nhật trạng thái thành công!'
                            })
                            loadPage(page);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error:', error);
                        swal.fire({
                            icon: 'error',
                            title: 'Thông Báo',
                            text: 'Lỗi không xác định!'
                        })
                    }
                })
            } else {
                // If the user has not confirmed, then check the status of the checkbox and return it to its original state.
                if (status === 1) {
                    document.getElementById("input-status-" + idProduct).checked = false;
                } else {
                    document.getElementById("input-status-" + idProduct).checked = true;
                }
            }
        });

    }


</script>
<script th:inline="javascript">

    // function validPriceSale() {
    //     var priceSaleInput = document.getElementById('product-priceSale-update-input');
    //     var errorPriceSale = document.getElementById('error-priceSale-update');
    //
    //     priceSaleInput.addEventListener('input', function () {
    //         if (priceSaleInput.value.trim() !== '') {
    //             errorPriceSale.style.display = 'none';
    //         } else {
    //             errorPriceSale.style.display = 'block';
    //         }
    //     });
    // }

    function validPrice() {
        var priceInput = document.getElementById('product-price-update-input');
        var errorPrice = document.getElementById('error-price-update');

        priceInput.addEventListener('input', function () {
            if (priceInput.value.trim() !== '') {
                errorPrice.style.display = 'none';
            } else {
                errorPrice.style.display = 'block';
            }
        });
    }

    function validQuantity() {
        var quantityInput = document.getElementById('product-quantity-update-input');
        var errorQuantity = document.getElementById('error-quantity-update');

        quantityInput.addEventListener('input', function () {
            if (quantityInput.value.trim() !== '') {
                errorQuantity.style.display = 'none';
            } else {
                errorQuantity.style.display = 'block';
            }
        });
    }

    function validName() {
        var nameInput = document.getElementById('product-name-update-input');
        var errorName = document.getElementById('error-name-update');

        nameInput.addEventListener('input', function () {
            if (nameInput.value.trim() !== '') {
                errorName.style.display = 'none';
            } else {
                errorName.style.display = 'block';
            }
        });
    }

    function validCollections() {
        var collectionsInput = document.getElementById('product-category-update-input');
        var errorCollections = document.getElementById('error-category-update');

        if (collectionsInput.value !== "-1") {
            errorCollections.style.display = 'none';
        } else {
            errorCollections.style.display = 'block';
        }

    }

    function validType() {
        var typeInput = document.getElementById('product-type-update-input');
        var errorType = document.getElementById('error-type-update');

        if (typeInput.value !== "-1") {
            errorType.style.display = 'none';
        } else {
            errorType.style.display = 'block';
        }

    }

    function validCollar() {
        var collarInput = document.getElementById('product-collar-update-input');
        var errorcollar = document.getElementById('error-collar-update');

        if (collarInput.value !== "-1") {
            errorcollar.style.display = 'none';
        } else {
            errorcollar.style.display = 'block';
        }
    }

    function validBrand() {
        var brandInput = document.getElementById('product-brand-update-input');
        var errorBrand = document.getElementById('error-brand-update');

        if (brandInput.value !== "-1") {
            errorBrand.style.display = 'none';
        } else {
            errorBrand.style.display = 'block';
        }
    }

</script>
</html>